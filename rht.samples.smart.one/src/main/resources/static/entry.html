<!DOCTYPE html>
<html>
  <head>
     <meta charset="UTF-8">
     <title>SMART Simple Auth App</title>
     <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  </head>
  <body>
		<h2>Sample SMART app</h2>  
    <script>
		console.log("Loading emtry.html...")

        // get the URL parameters received from the authorization server
        var authcode = getUrlParameter("code");    // authorization code
        var sessionKey = getUrlParameter("state");  // session key
        console.log("OAuth2 authorization code = "+authcode)
        console.log("Session key = "+sessionKey)
        
        // load the app parameters stored in the session
        var params = JSON.parse(sessionStorage[sessionKey]);  // load app session
        var tokenServiceUri = params.tokenUri;
        var clientId = params.clientId;
        var launchContextId = params.launchContextId;
        var serviceUri = params.serviceUri;
        var redirectUri = params.redirectUri;
        
        // Prep the token service request parameters
        var requestParameters = {
        	client_id: clientId,
            code: authcode,
            grant_type: 'authorization_code',
            redirect_uri: redirectUri
        };
        
        var requestOptions = {
            url: tokenServiceUri,
            type: 'POST',
            data: requestParameters
        };
        
        console.log(requestOptions);
        
        // obtain authorization token from the authorization service using the authorization code
        $.ajax(requestOptions)
        	.done(function(res){
	            // should get back the access token and the patient ID
	            var accessToken = res.access_token;
	            var patientId = res.patient;
	                    
	            // and now we can use these to construct standard FHIR
	            // REST calls to obtain patient resources with the
	            // SMART on FHIR-specific authorization header...
	            // Let's, for example, grab the patient resource and
	            // print the patient name on the screen
	            var url = serviceUri + "/Patient/" + patientId;
	            $.ajax({
	                url: url,
	                type: "GET",
	                dataType: "json",
	                headers: {
	                    "Authorization": "Bearer " + accessToken
	                },
	            }).done(function(pt){
	                var name = pt.name[0].given.join(" ") +" "+ pt.name[0].family.join(" ");
	                document.body.innerHTML += "<h3>Patient: " + name + "</h3>";
	            });
	        })
            .error(function(xhr) {
       			console.log("request failed for: "+tokenServiceUri+ " => "+xhr.statusText)
			});
        
        // Convenience function for parsing of URL parameters
        // based on http://www.jquerybyexample.net/2012/06/get-url-parameters-using-jquery.html
        function getUrlParameter(sParam)
        {
            var sPageURL = window.location.search.substring(1);
            var sURLVariables = sPageURL.split('&');
            for (var i = 0; i < sURLVariables.length; i++) 
            {
                var sParameterName = sURLVariables[i].split('=');
                if (sParameterName[0] == sParam) {
                    var res = sParameterName[1].replace(/\+/g, '%20');
                    return decodeURIComponent(res);
                }
            }
        }
    </script>
  </body>
</html>
